// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User roles enum
enum Role {
  admin
  designer
  requester
}

// User status enum
enum UserStatus {
  active
  inactive
}

// Request status enum
enum RequestStatus {
  draft
  submitted
  assigned
  in_design
  in_review
  changes_requested
  ready_to_publish   // Design ready for publish (can be marked by designer or requester after approval)
  completed          // Designer marks as completed (skipping changes, ready for publish)
  published          // Requester publishes with a link
  archived
}

// Request priority enum
enum Priority {
  low
  medium
  high
  campaign_critical
}

// Asset type enum - source files vs final deliverables
enum AssetType {
  source    // Working files (PSD, AI, etc.) - visible to designers and admins
  final     // Final deliverables - visible to everyone including requesters
}

// Role change request status
enum RoleChangeStatus {
  pending
  approved
  rejected
}

// User model - linked to Supabase auth.users
model User {
  id                      String              @id // UUID from Supabase auth.users
  username                String              @unique
  email                   String              @unique
  role                    Role                @default(requester)
  status                  UserStatus          @default(active)
  phone                   String?
  department              String?
  bio                     String?
  lastLogin               DateTime?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  // Relations
  requestsCreated         Request[]           @relation("RequestRequester")
  requestsAssigned        Request[]           @relation("RequestDesigner")
  cataloguesCreated       Catalogue[]
  comments                Comment[]
  assetsUploaded          Asset[]
  notificationsReceived   Notification[]      @relation("NotificationRecipient")
  notificationsSent       Notification[]      @relation("NotificationSender")
  roleChangeRequests      RoleChangeRequest[] @relation("RoleChangeRequester")
  roleChangeReviews       RoleChangeRequest[] @relation("RoleChangeReviewer")
  auditLogs               AuditLog[]          @relation("AuditPerformer")
  settingsUpdated         SystemSetting[]     @relation("SettingUpdater")

  @@map("users")
}

// Role change request model - needs admin approval
model RoleChangeRequest {
  id            String           @id @default(cuid())
  currentRole   Role
  requestedRole Role
  status        RoleChangeStatus @default(pending)
  reason        String?
  reviewNote    String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  userId        String
  user          User             @relation("RoleChangeRequester", fields: [userId], references: [id], onDelete: Cascade)

  reviewedById  String?
  reviewedBy    User?            @relation("RoleChangeReviewer", fields: [reviewedById], references: [id])

  @@map("role_change_requests")
}

// Catalogue model for grouping requests
model Catalogue {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  
  requests    Request[]

  @@map("catalogues")
}

// Request model (Design Request Management)
model Request {
  id            String         @id @default(cuid())
  drmCode       String         @unique
  name          String
  description   String?
  referenceLink String?        // Reference URL provided by requester (e.g., inspiration, brand guidelines)
  status        RequestStatus  @default(draft)
  priority      Priority       @default(medium)
  dueDate       DateTime?
  publishedLink String?        // Link where the design was published (required for published status)
  publishedAt   DateTime?      // When the design was published
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  requesterId   String
  requester     User           @relation("RequestRequester", fields: [requesterId], references: [id])
  
  designerId    String?
  designer      User?          @relation("RequestDesigner", fields: [designerId], references: [id])
  
  catalogueId   String?
  catalogue     Catalogue?     @relation(fields: [catalogueId], references: [id], onDelete: SetNull)
  
  comments      Comment[]
  assets        Asset[]
  notifications Notification[]

  @@map("requests")
}

// Comment model for request discussions
model Comment {
  id          Int       @id @default(autoincrement())
  content     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  requestId   String
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])

  @@map("comments")
}

// Asset model for uploaded files
model Asset {
  id          Int       @id @default(autoincrement())
  filename    String
  fileUrl     String
  fileType    String    // MIME type
  fileSize    Int       // Size in bytes
  assetType   AssetType @default(source)  // source or final
  version     Int       @default(1)
  versionNote String?   // Optional note about this version
  createdAt   DateTime  @default(now())

  // Relations
  requestId   String
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@map("assets")
}

// Audit log for admin action tracking
model AuditLog {
  id            Int      @id @default(autoincrement())
  action        String   // e.g., "user.role_changed", "user.deactivated", "settings.updated"
  targetType    String   // e.g., "user", "request", "system"
  targetId      String?  // ID of the affected entity
  details       Json?    // Additional context as JSON
  ipAddress     String?
  createdAt     DateTime @default(now())

  // Relations
  performedById String
  performedBy   User     @relation("AuditPerformer", fields: [performedById], references: [id])

  @@map("audit_logs")
}

// System settings key-value store
model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @default(now())

  // Relations
  updatedById String?
  updatedBy   User?    @relation("SettingUpdater", fields: [updatedById], references: [id])

  @@map("system_settings")
}

// Notification type enum
enum NotificationType {
  feedback          // Requester added feedback
  comment           // Designer/Admin added comment
  status_change     // Request status changed
  assignment        // Designer assigned to request
  asset_uploaded    // New asset uploaded
}

// Notification model for real-time alerts
model Notification {
  id          Int              @id @default(autoincrement())
  type        NotificationType
  title       String
  message     String
  link        String?          // Optional link to related item
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  // Relations
  userId      String           // User who receives the notification
  user        User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  
  fromUserId  String?          // User who triggered the notification (optional)
  fromUser    User?            @relation("NotificationSender", fields: [fromUserId], references: [id])
  
  requestId   String?          // Related request (optional)
  request     Request?         @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
